<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><title>Kits Inventory</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body{padding:1rem;} table{font-size:.88rem;} th{white-space:nowrap;}
</style>
</head>
<body>
<h3 class="mb-3">Kits Inventory</h3>

<div class="d-flex flex-wrap gap-2 mb-2">
  <input id="searchInput" class="form-control w-auto" style="min-width:220px"
         placeholder="Search Kit No / Operatorâ€¦">
  <button class="btn btn-primary"  onclick="openAddModal()">Add Kit</button>
  <button class="btn btn-danger"   onclick="bulkDelete()">Delete Selected</button>
  <button class="btn btn-success"  onclick="exportExcel()">Export Excel</button>
</div>

<table class="table table-bordered table-hover" id="kitsTable">
  <thead class="table-light"></thead>
  <tbody></tbody>
</table>

<!-- Modal -->
<div class="modal fade" id="kitModal" tabindex="-1">
 <div class="modal-dialog modal-xl"><div class="modal-content">
  <div class="modal-header"><h5 id="kitModalLabel" class="modal-title">Add Kit</h5>
       <button class="btn-close" data-bs-dismiss="modal"></button></div>
  <div class="modal-body"><form id="kitForm" class="row g-3"></form></div>
  <div class="modal-footer">
     <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
     <button class="btn btn-primary" onclick="submitKit()">Save</button>
  </div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const API='/api/kits'; let COLS=[],editMode=false,currentKey=null;
const kitModal=new bootstrap.Modal('#kitModal');

async function loadKits(){
  const j=await (await fetch('/api/kits_inventory')).json();
  const rows=j.data||[], head=document.querySelector('#kitsTable thead'),
        body=document.querySelector('#kitsTable tbody'); body.innerHTML='';
  if(!rows.length){head.innerHTML='';return;}
  if(!COLS.length){COLS=j.columns;
    head.innerHTML=`<tr>
      <th><input type="checkbox" id="masterChk" onclick="toggleAll(this)"></th>
      ${COLS.map(c=>`<th>${c}</th>`).join('')}<th>Actions</th></tr>`;}
  for(const r of rows){
    body.insertAdjacentHTML('beforeend',`<tr>
      <td><input type="checkbox" class="rowChk" value="${r.kit_no}"></td>
      ${COLS.map(c=>`<td>${r[c]??''}</td>`).join('')}
      <td class="text-nowrap">
        <button class="btn btn-sm btn-outline-primary"
                onclick='openEditModal(${JSON.stringify(r)})'>Edit</button>
        <a class="btn btn-sm btn-outline-info" target="_blank"
           href="/kit-form/${r.kit_no}">Form</a>
        <a class="btn btn-sm btn-outline-secondary" target="_blank"
           href="/handover/${r.kit_no}">Print</a>
      </td></tr>`);
  }}
loadKits();

document.getElementById('searchInput').addEventListener('keyup',e=>{
  const t=e.target.value.toLowerCase();
  document.querySelectorAll('#kitsTable tbody tr').forEach(tr=>{
    tr.style.display=tr.textContent.toLowerCase().includes(t)?'':'none';});
});

function buildForm(d){
  const f=document.getElementById('kitForm'); f.innerHTML='';
  COLS.forEach(c=>f.insertAdjacentHTML('beforeend',`
    <div class="col-md-6"><label class="form-label">${c}</label>
    <input class="form-control" name="${c}" value="${d[c]??''}"></div>`));}

function openAddModal(){editMode=false;currentKey=null;
  document.getElementById('kitModalLabel').textContent='Add Kit';buildForm({});kitModal.show();}
function openEditModal(row){editMode=true;currentKey=row.kit_no;
  document.getElementById('kitModalLabel').textContent='Edit Kit';buildForm(row);kitModal.show();}

async function submitKit(){
  const data=Object.fromEntries(new FormData(document.getElementById('kitForm')));
  const res=await fetch(editMode?`${API}/${currentKey}`:API,{
       method:editMode?'PUT':'POST',
       headers:{'Content-Type':'application/json'},
       body:JSON.stringify(data)});
  const out=await res.json();
  if(out.status==='success'){kitModal.hide();loadKits();}else alert(out.message);
}

async function bulkDelete(){
  const ids=[...document.querySelectorAll('.rowChk:checked')].map(c=>c.value);
  if(!ids.length||!confirm(`Delete ${ids.length} kits?`))return;
  const res=await fetch('/api/kits/bulk-delete',{method:'POST',
       headers:{'Content-Type':'application/json'},
       body:JSON.stringify({kitNos:ids})});
  alert((await res.json()).message);loadKits();}
function toggleAll(m){document.querySelectorAll('.rowChk').forEach(c=>c.checked=m.checked);}
function exportExcel(){location='/export/excel';}
</script>
</body></html>
